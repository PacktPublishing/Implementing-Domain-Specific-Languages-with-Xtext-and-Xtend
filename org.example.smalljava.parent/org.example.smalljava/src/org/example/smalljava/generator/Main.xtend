/*
 * generated by Xtext 2.10.0
 */
package org.example.smalljava.generator

import com.google.inject.Inject
import com.google.inject.Provider
import org.eclipse.emf.common.util.URI
import org.eclipse.emf.ecore.resource.ResourceSet
import org.eclipse.xtext.generator.GeneratorContext
import org.eclipse.xtext.generator.GeneratorDelegate
import org.eclipse.xtext.generator.JavaIoFileSystemAccess
import org.eclipse.xtext.util.CancelIndicator
import org.eclipse.xtext.validation.CheckMode
import org.eclipse.xtext.validation.IResourceValidator
import org.example.smalljava.SmallJavaLib
import org.example.smalljava.SmallJavaStandaloneSetup

class Main {

	def static main(String[] args) {
		if (args.empty) {
			System::err.println('Aborting: no path to EMF resource provided!')
			return
		}
		val injector = new SmallJavaStandaloneSetup().createInjectorAndDoEMFRegistration
		val main = injector.getInstance(Main)
		main.runGenerator(args)
	}

	@Inject Provider<ResourceSet> resourceSetProvider

	@Inject IResourceValidator validator

	@Inject GeneratorDelegate generator

	@Inject JavaIoFileSystemAccess fileAccess

	@Inject SmallJavaLib smallJavaLib

	def protected runGenerator(String[] strings) {
		val set = resourceSetProvider.get
		// Configure the generator
		fileAccess.outputPath = 'src-gen/'
		val context = new GeneratorContext => [
			cancelIndicator = CancelIndicator.NullImpl
		]
		// load the library
		smallJavaLib.loadLib(set)
		// load the input files
		strings.forEach[s|set.getResource(URI.createFileURI(s), true)]
		// validate the resources
		var ok = true
		for (resource : set.resources) {
			println("Compiling " + resource.URI + "...")
			val issues = validator.validate(resource, CheckMode.ALL, CancelIndicator.NullImpl)
			if (!issues.isEmpty()) {
				for (issue : issues) {
					System.err.println(issue)
				}
				ok = false
			} else {
				generator.generate(resource, fileAccess, context)
			}
		}
		if (ok)
			System.out.println('Programs well-typed.')
	}
}
